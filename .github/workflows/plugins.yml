name: Plugins

on:
  push:
    branches: [main]
    paths:
      - "plugins/**"
      - "crates/**"
      - "src/**"
      - "wit/**"
      - "Cargo.toml"
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/plugins.yml"
      - "plugins/**"
      - "crates/**"
      - "src/**"
      - "wit/**"
      - "Cargo.toml"

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  test-plugins:
    name: Test Plugins (${{ matrix.chunk }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: [0, 1, 2, 3]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-plugins-${{ matrix.chunk }}"
      - name: Test plugin chunk
        run: |
          plugins=(plugins/builtin/*/*/)
          total=${#plugins[@]}
          chunks=4
          chunk=${{ matrix.chunk }}
          start=$(( chunk * total / chunks ))
          end=$(( (chunk + 1) * total / chunks ))

          for (( i=start; i<end; i++ )); do
            dir="${plugins[$i]}"
            if [ -f "$dir/Cargo.toml" ]; then
              echo "Testing $(basename $dir)..."
              (cd "$dir" && cargo test)
            fi
          done

  wasm-build:
    name: Build WASM Plugins (${{ matrix.chunk }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: [0, 1]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "wasm-build-${{ matrix.chunk }}"
      - name: Install wasm-tools
        run: |
          WASM_TOOLS_VERSION=1.245.1
          curl -sSfL "https://github.com/bytecodealliance/wasm-tools/releases/download/v${WASM_TOOLS_VERSION}/wasm-tools-${WASM_TOOLS_VERSION}-x86_64-linux.tar.gz" \
            | tar xz --strip-components=1 --wildcards "*/wasm-tools"
          mv wasm-tools /usr/local/bin/
          wasm-tools --version
      - name: Build WASM plugin chunk
        run: |
          plugins=(plugins/builtin/*/*/)
          total=${#plugins[@]}
          chunks=2
          chunk=${{ matrix.chunk }}
          start=$(( chunk * total / chunks ))
          end=$(( (chunk + 1) * total / chunks ))

          for (( i=start; i<end; i++ )); do
            dir="${plugins[$i]}"
            if [ -f "$dir/Cargo.toml" ]; then
              name=$(basename "$dir")
              echo "Building $name..."
              cargo build --manifest-path "$dir/Cargo.toml" \
                --target wasm32-unknown-unknown \
                --target-dir target/wasm-plugins \
                --release
              wasm_name=$(echo "$name" | tr '-' '_')_plugin
              core_wasm="target/wasm-plugins/wasm32-unknown-unknown/release/$wasm_name.wasm"
              out_dir="$dir/target/wasm32-unknown-unknown/release"
              mkdir -p "$out_dir"
              wasm-tools component new "$core_wasm" -o "$out_dir/$wasm_name.wasm.component.wasm"
            fi
          done
      - name: Package WASM components
        run: |
          find plugins/builtin -name "*.wasm.component.wasm" \
            | tar czf "wasm-components-${{ matrix.chunk }}.tar.gz" -T -
      - uses: actions/upload-artifact@v6
        with:
          name: wasm-plugins-${{ matrix.chunk }}
          path: wasm-components-${{ matrix.chunk }}.tar.gz
          retention-days: 1

  build-host:
    name: Build Host Binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-host"
      - name: Build nginx-lint and test binary
        run: |
          cargo build --release --no-default-features --features cli,plugins
          cargo test --test wasm_plugin_test --no-default-features --features cli,plugins --release --no-run
      - name: Package binaries
        run: |
          mkdir -p artifacts
          cp target/release/nginx-lint artifacts/
          find target/release/deps -name 'wasm_plugin_test-*' -type f -executable | head -1 | xargs -I{} cp {} artifacts/wasm_plugin_test
      - uses: actions/upload-artifact@v6
        with:
          name: host-binaries
          path: artifacts/
          retention-days: 1

  wasm-integration:
    name: WASM Integration Test
    needs: [wasm-build, typescript-plugin, build-host]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          pattern: wasm-plugins-*
          merge-multiple: true
      - uses: actions/download-artifact@v7
        with:
          name: ts-plugin
          path: target/ts-plugins
      - uses: actions/download-artifact@v7
        with:
          name: host-binaries
          path: artifacts
      - name: Extract WASM plugins
        run: |
          for f in wasm-components-*.tar.gz; do
            tar xzf "$f"
          done
          echo "Discovered WASM plugins:"
          find plugins/builtin -name "*.wasm.component.wasm" | sort
      - name: Run WASM integration tests
        run: |
          chmod +x artifacts/wasm_plugin_test
          ./artifacts/wasm_plugin_test
      - name: Test TypeScript plugin integration
        run: |
          chmod +x artifacts/nginx-lint
          NGINX_LINT=./artifacts/nginx-lint

          # bad.conf should produce warnings from the TS plugin
          output=$($NGINX_LINT --plugins target/ts-plugins --format json plugins/typescript/server-tokens-enabled-ts/examples/bad.conf || true)
          echo "$output"
          echo "$output" | jq -e '.errors[] | select(.rule == "server-tokens-enabled-ts")' > /dev/null

          # good.conf should NOT produce warnings from the TS plugin
          output=$($NGINX_LINT --plugins target/ts-plugins --format json plugins/typescript/server-tokens-enabled-ts/examples/good.conf || true)
          echo "$output"
          if echo "$output" | jq -e '.errors[] | select(.rule == "server-tokens-enabled-ts")' > /dev/null 2>&1; then
            echo "ERROR: good.conf should not produce errors from server-tokens-enabled-ts"
            exit 1
          fi

  typescript-plugin:
    name: TypeScript Plugin
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "24"
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-parser-wasm"
      - name: Install wasm-tools
        run: |
          WASM_TOOLS_VERSION=1.245.1
          curl -sSfL "https://github.com/bytecodealliance/wasm-tools/releases/download/v${WASM_TOOLS_VERSION}/wasm-tools-${WASM_TOOLS_VERSION}-x86_64-linux.tar.gz" \
            | tar xz --strip-components=1 --wildcards "*/wasm-tools"
          mv wasm-tools /usr/local/bin/
      - name: Install shared library dependencies
        working-directory: plugins/typescript/nginx-lint-plugin
        run: npm install
      - name: Build parser WASM component
        run: make build-parser-wasm
      - name: Build shared library
        working-directory: plugins/typescript/nginx-lint-plugin
        run: npm run build
      - name: Build TypeScript plugin
        working-directory: plugins/typescript/server-tokens-enabled-ts
        run: |
          npm install
          npm run build
      - name: Run TypeScript unit tests
        working-directory: plugins/typescript/server-tokens-enabled-ts
        run: npm test
      - name: Upload TypeScript WASM plugin
        uses: actions/upload-artifact@v6
        with:
          name: ts-plugin
          path: plugins/typescript/server-tokens-enabled-ts/dist/server-tokens-enabled-ts.wasm
          retention-days: 1
