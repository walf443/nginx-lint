name: Container Tests

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/container-tests.yml"
      - "plugins/builtin/**/tests/container_test.rs"
      - "crates/nginx-lint-plugin/src/container_testing.rs"

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  container-tests:
    name: Container Tests (${{ matrix.nginx-image }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        nginx-image: ["nginx:1.28", "nginx:1.29", "openresty/openresty:noble"]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "container-tests"

      - name: Pull image
        run: docker pull ${{ matrix.nginx-image }}

      - name: Pull CoreDNS image
        run: docker pull coredns/coredns:latest

      - name: Run container tests
        env:
          NGINX_IMAGE: ${{ matrix.nginx-image }}
        run: |
          failed_plugins=""
          passed=0
          failed=0
          for dir in plugins/builtin/*/*/; do
            if [ -f "$dir/tests/container_test.rs" ]; then
              name=$(basename "$dir")
              pkg=$(grep '^name = ' "$dir/Cargo.toml" | head -1 | sed 's/name = "\(.*\)"/\1/')
              echo "::group::$name (${{ matrix.nginx-image }})"
              if cargo test -p "$pkg" --test container_test -- --ignored; then
                echo "✅ $name passed"
                passed=$((passed + 1))
              else
                echo "❌ $name failed"
                failed=$((failed + 1))
                failed_plugins="$failed_plugins $name"
                echo "::error title=$name failed::Container test for $name failed with ${{ matrix.nginx-image }}"
              fi
              echo "::endgroup::"
            fi
          done
          echo ""
          echo "=== Summary (${{ matrix.nginx-image }}) ==="
          echo "Passed: $passed"
          echo "Failed: $failed"
          if [ -n "$failed_plugins" ]; then
            echo ""
            echo "Failed plugins:"
            for p in $failed_plugins; do
              echo "  - $p"
            done
            exit 1
          fi
