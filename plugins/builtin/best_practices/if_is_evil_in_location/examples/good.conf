http {
  server {
    # Safe: use separate location for PHP files
    location ~ \.php$ {
      proxy_pass http://php_backend;
    }

    location / {
      # Safe: return inside if
      if ($request_method = POST) {
        return 405;
      }

      # Safe: set inside if
      set $backend "default";
      if ($uri ~* ^/api/) {
        set $backend "api_server";
      }

      # Safe: rewrite ... last inside if
      if ($host ~* ^www\.) {
        rewrite ^(.*)$ https://example.com$1 last;
      }

      proxy_pass http://$backend;
    }
  }
}
