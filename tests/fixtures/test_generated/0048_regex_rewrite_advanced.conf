# Advanced regex rewrite patterns
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name rewrite.example.com;

        # Remove trailing slash
        rewrite ^/(.*)/$ /$1 permanent;

        # Add trailing slash to directories
        location ~ ^/[^.]*$ {
            rewrite ^(.*[^/])$ $1/ permanent;
        }

        # Remove multiple slashes
        if ($request_uri ~ "^[^?]*?//") {
            rewrite "^([^?]*?)//+(.*)$" $1/$2 permanent;
        }

        # Lowercase URLs
        location ~ [A-Z] {
            rewrite ^(.*)$ $scheme://$host$uri_lowercase permanent;
        }

        # Remove index.html/index.php
        rewrite ^(.*)/index\.(html|htm|php)$ $1/ permanent;

        # SEO-friendly URL rewrites
        rewrite ^/products/([0-9]+)/([a-z0-9-]+)$ /product.php?id=$1&slug=$2 last;
        rewrite ^/category/([a-z0-9-]+)$ /category.php?name=$1 last;
        rewrite ^/tag/([a-z0-9-]+)$ /tag.php?name=$1 last;

        # Pagination rewrites
        rewrite ^/blog/page/([0-9]+)$ /blog?page=$1 last;
        rewrite ^/([a-z0-9-]+)/page/([0-9]+)$ /$1?page=$2 last;

        # Date-based archive rewrites
        rewrite ^/archive/([0-9]{4})$ /archive.php?year=$1 last;
        rewrite ^/archive/([0-9]{4})/([0-9]{2})$ /archive.php?year=$1&month=$2 last;
        rewrite ^/archive/([0-9]{4})/([0-9]{2})/([0-9]{2})$ /archive.php?year=$1&month=$2&day=$3 last;

        # Username-based routing
        rewrite ^/@([a-zA-Z0-9_]{3,20})$ /user/$1 last;
        rewrite ^/@([a-zA-Z0-9_]{3,20})/(.*)$ /user/$1/$2 last;

        # Hash-based routing (single page app)
        rewrite ^/app/(.*)$ /app/index.html last;

        # API version migration
        rewrite ^/api/v1\.0/(.*)$ /api/v1/$1 permanent;
        rewrite ^/api/v1\.1/(.*)$ /api/v1/$1 permanent;
        rewrite ^/api/v1\.2/(.*)$ /api/v1/$1 permanent;

        # Legacy URL redirects
        rewrite ^/old-blog/([0-9]+)$ /blog/post/$1 permanent;
        rewrite ^/oldsite/(.*)$ /$1 permanent;

        # Vanity URLs
        rewrite ^/go/([a-z0-9]+)$ /redirect/$1 last;

        # Short URLs
        rewrite ^/s/([a-zA-Z0-9]{6,10})$ /short?code=$1 last;

        # File download with clean URLs
        rewrite ^/download/([a-z0-9-]+)/([^/]+)$ /files/$1/$2?download=1 last;

        # Image resizing proxy
        rewrite ^/img/([0-9]+)x([0-9]+)/(.*)$ /resize.php?w=$1&h=$2&src=$3 last;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }
    }

    # Map for lowercase conversion (simplified)
    map $uri $uri_lowercase {
        default $uri;
    }
}
