# IP restriction and geo-based access control
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Define allowed/blocked networks
    geo $blocked_country {
        default 0;
        10.0.0.0/8 0;
        192.168.0.0/16 0;
        # Add blocked ranges
        203.0.113.0/24 1;
    }

    geo $internal_network {
        default 0;
        127.0.0.1/32 1;
        10.0.0.0/8 1;
        172.16.0.0/12 1;
        192.168.0.0/16 1;
    }

    server {
        listen 80;
        server_name secure.example.com;

        # Block by geo
        if ($blocked_country) {
            return 403;
        }

        location / {
            root /var/www/html;
            index index.html;
        }

        # Admin only from internal network
        location /admin {
            allow 10.0.0.0/8;
            allow 192.168.0.0/16;
            allow 127.0.0.1;
            deny all;

            root /var/www/admin;
            index index.html;
        }

        # API with specific IP whitelist
        location /api/internal {
            allow 10.1.1.0/24;
            allow 10.2.2.0/24;
            deny all;

            proxy_pass http://127.0.0.1:8080;
        }

        # Metrics endpoint - internal only
        location /metrics {
            if ($internal_network = 0) {
                return 403;
            }
            proxy_pass http://127.0.0.1:9090;
        }
    }
}
