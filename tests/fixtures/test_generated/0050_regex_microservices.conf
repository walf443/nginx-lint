# Regex for microservices routing
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Service discovery via map
    map $uri $service_backend {
        ~^/api/users         users_service;
        ~^/api/orders        orders_service;
        ~^/api/products      products_service;
        ~^/api/payments      payments_service;
        ~^/api/notifications notifications_service;
        ~^/api/analytics     analytics_service;
        ~^/api/search        search_service;
        ~^/api/auth          auth_service;
        default              gateway_service;
    }

    upstream users_service {
        server users.internal:8080;
    }

    upstream orders_service {
        server orders.internal:8080;
    }

    upstream products_service {
        server products.internal:8080;
    }

    upstream payments_service {
        server payments.internal:8080;
    }

    upstream notifications_service {
        server notifications.internal:8080;
    }

    upstream analytics_service {
        server analytics.internal:8080;
    }

    upstream search_service {
        server search.internal:8080;
    }

    upstream auth_service {
        server auth.internal:8080;
    }

    upstream gateway_service {
        server gateway.internal:8080;
    }

    server {
        listen 80;
        server_name api.example.com;

        # User service routes
        location ~ ^/api/users/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$ {
            set $user_uuid $1;
            proxy_pass http://users_service/users/$user_uuid;
            proxy_set_header X-User-UUID $user_uuid;
        }

        location ~ ^/api/users/([0-9a-f-]+)/(profile|settings|preferences)$ {
            set $user_uuid $1;
            set $resource $2;
            proxy_pass http://users_service/users/$user_uuid/$resource;
        }

        # Order service routes
        location ~ ^/api/orders/([A-Z]{2}-[0-9]{8}-[0-9]{4})$ {
            set $order_id $1;
            proxy_pass http://orders_service/orders/$order_id;
            proxy_set_header X-Order-ID $order_id;
        }

        location ~ ^/api/orders/([A-Z]{2}-[0-9]{8}-[0-9]{4})/(items|status|tracking)$ {
            set $order_id $1;
            set $resource $2;
            proxy_pass http://orders_service/orders/$order_id/$resource;
        }

        # Product service routes
        location ~ ^/api/products/([A-Z]{3}[0-9]{6})$ {
            set $sku $1;
            proxy_pass http://products_service/products/$sku;
            proxy_set_header X-Product-SKU $sku;
        }

        location ~ ^/api/products/category/([a-z0-9-]+)$ {
            set $category $1;
            proxy_pass http://products_service/products/category/$category;
        }

        # Search service with query patterns
        location ~ ^/api/search/([a-z]+)$ {
            set $search_type $1;
            proxy_pass http://search_service/$search_type;
            proxy_set_header X-Search-Type $search_type;
        }

        # Analytics event tracking
        location ~ ^/api/analytics/events/([a-z_]+)$ {
            set $event_type $1;
            proxy_pass http://analytics_service/track/$event_type;
            proxy_set_header X-Event-Type $event_type;
        }

        # Auth service routes
        location ~ ^/api/auth/(login|logout|refresh|verify)$ {
            set $auth_action $1;
            proxy_pass http://auth_service/$auth_action;
        }

        # Catch-all for service routing
        location ~ ^/api/([a-z]+)/(.*)$ {
            set $service $1;
            set $path $2;
            proxy_pass http://$service_backend/$path;
            proxy_set_header X-Service $service;
            proxy_set_header X-Original-URI $request_uri;
        }

        # Health check endpoints
        location ~ ^/health/([a-z]+)$ {
            set $service $1;
            proxy_pass http://${service}_service/health;
            proxy_connect_timeout 2s;
            proxy_read_timeout 2s;
        }
    }
}
