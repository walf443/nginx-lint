# Regex with capture groups and backreferences
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name capture.example.com;

        # Single capture group
        location ~ ^/user/([0-9]+)$ {
            set $user_id $1;
            proxy_pass http://127.0.0.1:8080/api/users/$user_id;
        }

        # Multiple capture groups
        location ~ ^/blog/([0-9]{4})/([0-9]{2})/([0-9]{2})/([a-z0-9-]+)$ {
            set $year $1;
            set $month $2;
            set $day $3;
            set $slug $4;
            try_files /cache/$year/$month/$day/$slug.html @backend;
        }

        # Nested capture groups
        location ~ ^/product/(([a-z]+)-([0-9]+))$ {
            set $full_id $1;
            set $category $2;
            set $product_num $3;
            proxy_pass http://127.0.0.1:8080/products?id=$full_id&cat=$category&num=$product_num;
        }

        # Capture with optional group
        location ~ ^/api/v([0-9]+)(/.*)?$ {
            set $api_version $1;
            set $api_path $2;
            proxy_pass http://127.0.0.1:8080/api-v$api_version$api_path;
        }

        # Rewrite with capture groups
        rewrite ^/old/([a-z]+)/([0-9]+)$ /new/$1/$2 permanent;
        rewrite ^/legacy/(.*)$ /modern/$1 last;

        # Named-like captures using set
        location ~ ^/order/([A-Z]{2})([0-9]{6})$ {
            set $country_code $1;
            set $order_number $2;
            proxy_set_header X-Country $country_code;
            proxy_set_header X-Order $order_number;
            proxy_pass http://127.0.0.1:8080;
        }

        location @backend {
            proxy_pass http://127.0.0.1:8080;
        }
    }
}
