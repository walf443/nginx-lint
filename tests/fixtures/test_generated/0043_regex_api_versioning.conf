# Regex for API versioning patterns
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream api_v1 {
        server 10.0.0.1:8080;
    }

    upstream api_v2 {
        server 10.0.0.2:8080;
    }

    upstream api_v3 {
        server 10.0.0.3:8080;
    }

    upstream api_latest {
        server 10.0.0.3:8080;
    }

    map $uri $api_backend {
        ~^/api/v1/  api_v1;
        ~^/api/v2/  api_v2;
        ~^/api/v3/  api_v3;
        default     api_latest;
    }

    server {
        listen 80;
        server_name api.example.com;

        # URL path versioning: /api/v1/users
        location ~ ^/api/v([0-9]+)/(.*)$ {
            set $api_version $1;
            set $api_endpoint $2;
            proxy_pass http://$api_backend/$api_endpoint;
            proxy_set_header X-API-Version $api_version;
        }

        # Semantic versioning in URL: /api/v1.2.3/users
        location ~ ^/api/v([0-9]+)\.([0-9]+)\.([0-9]+)/(.*)$ {
            set $major $1;
            set $minor $2;
            set $patch $3;
            set $endpoint $4;
            proxy_pass http://api_v$major/$endpoint;
            proxy_set_header X-API-Version "$major.$minor.$patch";
        }

        # Date-based versioning: /api/2024-01-15/users
        location ~ ^/api/([0-9]{4})-([0-9]{2})-([0-9]{2})/(.*)$ {
            set $year $1;
            set $month $2;
            set $day $3;
            set $endpoint $4;
            proxy_pass http://api_latest/$endpoint;
            proxy_set_header X-API-Date "$year-$month-$day";
        }

        # Header-based versioning fallback
        location ~ ^/api/(.*)$ {
            set $endpoint $1;
            proxy_pass http://api_latest/$endpoint;
            proxy_set_header X-API-Version $http_x_api_version;
        }

        # GraphQL endpoint with version
        location ~ ^/graphql/v([0-9]+)$ {
            set $gql_version $1;
            proxy_pass http://api_v$gql_version/graphql;
        }

        # Deprecated API warning
        location ~ ^/api/v0/ {
            add_header X-API-Deprecated "true";
            add_header X-API-Sunset "2024-12-31";
            proxy_pass http://api_v1;
        }
    }
}
