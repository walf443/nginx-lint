# Mail proxy configuration (IMAP/SMTP/POP3)
worker_processes auto;

events {
    worker_connections 1024;
}

mail {
    server_name mail.example.com;
    auth_http localhost:9000/auth;

    # IMAP proxy
    server {
        listen 143;
        listen [::]:143;
        protocol imap;
        proxy_pass_error_message on;
    }

    # IMAPS proxy
    server {
        listen 993 ssl;
        listen [::]:993 ssl;
        protocol imap;
        ssl_certificate /etc/ssl/certs/mail.crt;
        ssl_certificate_key /etc/ssl/private/mail.key;
        ssl_protocols TLSv1.2 TLSv1.3;
    }

    # POP3 proxy
    server {
        listen 110;
        listen [::]:110;
        protocol pop3;
    }

    # POP3S proxy
    server {
        listen 995 ssl;
        listen [::]:995 ssl;
        protocol pop3;
        ssl_certificate /etc/ssl/certs/mail.crt;
        ssl_certificate_key /etc/ssl/private/mail.key;
    }

    # SMTP proxy
    server {
        listen 25;
        listen [::]:25;
        protocol smtp;
        smtp_auth login plain;
    }

    # SMTPS proxy
    server {
        listen 465 ssl;
        listen [::]:465 ssl;
        protocol smtp;
        ssl_certificate /etc/ssl/certs/mail.crt;
        ssl_certificate_key /etc/ssl/private/mail.key;
        smtp_auth login plain cram-md5;
    }

    # Submission proxy
    server {
        listen 587;
        listen [::]:587;
        protocol smtp;
        starttls on;
        ssl_certificate /etc/ssl/certs/mail.crt;
        ssl_certificate_key /etc/ssl/private/mail.key;
    }
}
