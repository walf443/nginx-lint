# Regex for query string patterns
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Extract specific query parameters
    map $args $page_num {
        default 1;
        ~(?:^|&)page=([0-9]+) $1;
    }

    map $args $sort_order {
        default "asc";
        ~(?:^|&)sort=(asc|desc) $1;
    }

    map $args $filter_category {
        default "";
        ~(?:^|&)category=([a-z0-9_-]+) $1;
    }

    # Check for specific parameters
    map $args $has_debug {
        default 0;
        ~(?:^|&)debug=1 1;
        ~(?:^|&)debug=true 1;
    }

    map $args $has_nocache {
        default 0;
        ~(?:^|&)nocache(?:=|&|$) 1;
        ~(?:^|&)_=[0-9]+ 1;
    }

    server {
        listen 80;
        server_name query.example.com;

        location / {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header X-Page $page_num;
            proxy_set_header X-Sort $sort_order;
            proxy_set_header X-Category $filter_category;
            proxy_set_header X-Debug $has_debug;
        }

        # Cache bypass based on query string
        location /api/ {
            proxy_cache api_cache;
            proxy_cache_bypass $has_nocache;
            proxy_no_cache $has_nocache $has_debug;
            proxy_pass http://127.0.0.1:8080;
        }

        # Rewrite query string patterns
        location /search {
            # Convert /search?q=term to /search/term
            if ($args ~ "^q=([^&]+)$") {
                rewrite ^ /search/$1? permanent;
            }
            proxy_pass http://127.0.0.1:8080;
        }

        # Strip tracking parameters
        location /clean/ {
            if ($args ~ "^(.*)(?:&?)(utm_[a-z]+|fbclid|gclid|mc_[a-z]+)=[^&]*(.*)$") {
                rewrite ^(.*)$ $1?$1$3 redirect;
            }
            proxy_pass http://127.0.0.1:8080;
        }

        # Validate pagination parameters
        location /list {
            # Block invalid page numbers
            if ($args ~ "page=(-[0-9]+|0|[0-9]{5,})") {
                return 400;
            }
            # Block invalid limit values
            if ($args ~ "limit=([0-9]{4,}|0)") {
                return 400;
            }
            proxy_pass http://127.0.0.1:8080;
        }

        # OAuth callback handling
        location /oauth/callback {
            # Extract authorization code
            if ($args ~ "code=([a-zA-Z0-9_-]+)") {
                set $auth_code $1;
            }
            # Extract state parameter
            if ($args ~ "state=([a-zA-Z0-9_-]+)") {
                set $oauth_state $1;
            }
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header X-Auth-Code $auth_code;
            proxy_set_header X-OAuth-State $oauth_state;
        }
    }

    proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:10m max_size=100m;
}
