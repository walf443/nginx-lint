# Stream proxy configuration (TCP/UDP load balancing with IPv6)
worker_processes auto;

events {
    worker_connections 1024;
}

stream {
    # Logging
    log_format basic '$remote_addr [$time_local] $protocol $status $bytes_sent $bytes_received $session_time';

    access_log /var/log/nginx/stream.log basic;

    # TCP upstream for MySQL (mixed IPv4/IPv6)
    upstream mysql_backend {
        server 10.0.0.1:3306 weight=5;
        server [2001:db8::1]:3306 weight=5;
        server [2001:db8::2]:3306 backup;
    }

    # TCP upstream for PostgreSQL (IPv6 only)
    upstream postgres_backend {
        least_conn;
        server [2001:db8:1::10]:5432;
        server [2001:db8:1::11]:5432;
    }

    # UDP upstream for DNS (mixed)
    upstream dns_backend {
        server 8.8.8.8:53;
        server [2001:4860:4860::8888]:53;
        server [2001:4860:4860::8844]:53;
    }

    # TCP upstream for Redis
    upstream redis_backend {
        hash $remote_addr consistent;
        server [fd00::20]:6379;
        server [fd00::21]:6379;
        server [fd00::22]:6379;
    }

    # MySQL proxy (IPv4 and IPv6 dual-stack)
    server {
        listen 3306;
        listen [::]:3306;
        proxy_pass mysql_backend;
        proxy_connect_timeout 10s;
        proxy_timeout 300s;
    }

    # PostgreSQL proxy (IPv6 only)
    server {
        listen [::]:5432;
        proxy_pass postgres_backend;
        proxy_connect_timeout 5s;
        proxy_timeout 60s;
    }

    # DNS proxy (UDP dual-stack)
    server {
        listen 53 udp;
        listen [::]:53 udp;
        proxy_pass dns_backend;
        proxy_timeout 5s;
        proxy_responses 1;
    }

    # Redis proxy (IPv6 with specific address)
    server {
        listen [::1]:6379;
        listen [2001:db8::100]:6379;
        proxy_pass redis_backend;
        proxy_connect_timeout 1s;
        proxy_timeout 10s;
    }

    # SSL/TLS passthrough (dual-stack)
    server {
        listen 443;
        listen [::]:443;
        proxy_pass [2001:db8::200]:443;
        proxy_connect_timeout 5s;
    }
}
