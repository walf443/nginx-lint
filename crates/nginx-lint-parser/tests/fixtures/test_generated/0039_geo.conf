# Geo module configuration
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Country-based routing
    geo $country {
        default        unknown;
        127.0.0.0/8    local;
        10.0.0.0/8     internal;
        192.168.0.0/16 internal;
        172.16.0.0/12  internal;

        # Sample country blocks (normally from GeoIP)
        203.0.113.0/24 JP;
        198.51.100.0/24 US;
        192.0.2.0/24   EU;
    }

    # Datacenter routing based on client IP
    geo $datacenter {
        default        dc1;
        10.1.0.0/16    dc1;
        10.2.0.0/16    dc2;
        10.3.0.0/16    dc3;
    }

    # Rate limit zones by geo
    geo $rate_limit_zone {
        default        normal;
        127.0.0.0/8    unlimited;
        10.0.0.0/8     unlimited;
        192.168.0.0/16 unlimited;
    }

    # Block suspicious IPs
    geo $blocked {
        default 0;
        192.0.2.100 1;
        192.0.2.101 1;
        198.51.100.50/30 1;
    }

    map $datacenter $backend {
        dc1 backend_dc1;
        dc2 backend_dc2;
        dc3 backend_dc3;
    }

    upstream backend_dc1 {
        server 10.1.0.10:8080;
        server 10.1.0.11:8080;
    }

    upstream backend_dc2 {
        server 10.2.0.10:8080;
        server 10.2.0.11:8080;
    }

    upstream backend_dc3 {
        server 10.3.0.10:8080;
        server 10.3.0.11:8080;
    }

    limit_req_zone $binary_remote_addr zone=normal:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=unlimited:10m rate=1000r/s;

    server {
        listen 80;
        listen [::]:80;
        server_name geo.example.com;

        # Block suspicious IPs
        if ($blocked) {
            return 403;
        }

        location / {
            # Apply rate limit based on geo
            limit_req zone=$rate_limit_zone burst=20 nodelay;

            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Country $country;
            proxy_set_header X-Datacenter $datacenter;
        }

        # Country-specific content
        location /localized/ {
            alias /var/www/localized/$country/;
            try_files $uri $uri/ /localized/default/index.html;
        }
    }
}
