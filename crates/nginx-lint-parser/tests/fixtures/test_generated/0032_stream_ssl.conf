# Stream SSL/TLS termination and proxy
worker_processes auto;

events {
    worker_connections 1024;
}

stream {
    # SSL upstream
    upstream secure_backend {
        server 10.0.0.1:8443;
        server 10.0.0.2:8443;
    }

    # Map for SNI-based routing
    map $ssl_preread_server_name $backend_name {
        app1.example.com app1_backend;
        app2.example.com app2_backend;
        default default_backend;
    }

    upstream app1_backend {
        server 10.0.1.1:443;
        server 10.0.1.2:443;
    }

    upstream app2_backend {
        server 10.0.2.1:443;
        server 10.0.2.2:443;
    }

    upstream default_backend {
        server 10.0.0.100:443;
    }

    # SSL termination for database
    server {
        listen 3307 ssl;
        ssl_certificate /etc/ssl/certs/mysql.crt;
        ssl_certificate_key /etc/ssl/private/mysql.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        proxy_pass mysql_backend;
        proxy_ssl on;
        proxy_ssl_verify off;
    }

    upstream mysql_backend {
        server 10.0.0.50:3306;
    }

    # SNI-based routing (SSL passthrough)
    server {
        listen 443;
        ssl_preread on;
        proxy_pass $backend_name;
        proxy_connect_timeout 10s;
    }

    # Mutual TLS authentication
    server {
        listen 8443 ssl;
        ssl_certificate /etc/ssl/certs/server.crt;
        ssl_certificate_key /etc/ssl/private/server.key;
        ssl_client_certificate /etc/ssl/certs/ca.crt;
        ssl_verify_client on;
        ssl_verify_depth 2;

        proxy_pass secure_backend;
        proxy_ssl on;
        proxy_ssl_certificate /etc/ssl/certs/client.crt;
        proxy_ssl_certificate_key /etc/ssl/private/client.key;
    }
}
