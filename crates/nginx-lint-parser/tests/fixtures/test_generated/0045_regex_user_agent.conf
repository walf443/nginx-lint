# Regex for user agent matching
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Detect mobile devices
    map $http_user_agent $is_mobile {
        default 0;
        ~*android 1;
        ~*iphone 1;
        ~*ipad 1;
        ~*ipod 1;
        ~*mobile 1;
        ~*phone 1;
    }

    # Detect bots and crawlers
    map $http_user_agent $is_bot {
        default 0;
        ~*googlebot 1;
        ~*bingbot 1;
        ~*yandexbot 1;
        ~*baiduspider 1;
        ~*duckduckbot 1;
        ~*slurp 1;
        ~*facebookexternalhit 1;
        ~*twitterbot 1;
        ~*linkedinbot 1;
        ~*whatsapp 1;
        ~*telegrambot 1;
        ~*crawler 1;
        ~*spider 1;
        ~*bot 1;
    }

    # Detect browser type
    map $http_user_agent $browser {
        default other;
        ~*chrome chrome;
        ~*firefox firefox;
        ~*safari safari;
        ~*msie ie;
        ~*trident ie;
        ~*edge edge;
        ~*opera opera;
    }

    # Block malicious bots
    map $http_user_agent $bad_bot {
        default 0;
        ~*semrush 1;
        ~*ahrefsbot 1;
        ~*mj12bot 1;
        ~*dotbot 1;
        ~*blexbot 1;
        ~*petalbot 1;
        ~*bytespider 1;
        "" 1;
    }

    # Detect specific versions
    map $http_user_agent $chrome_version {
        default 0;
        "~*Chrome/([0-9]+)" $1;
    }

    server {
        listen 80;
        server_name ua.example.com;

        # Block bad bots
        if ($bad_bot) {
            return 403;
        }

        location / {
            # Serve different content for mobile
            if ($is_mobile) {
                rewrite ^(.*)$ /mobile$1 last;
            }

            proxy_pass http://127.0.0.1:8080;
            proxy_set_header X-Is-Mobile $is_mobile;
            proxy_set_header X-Is-Bot $is_bot;
            proxy_set_header X-Browser $browser;
        }

        location /mobile/ {
            proxy_pass http://127.0.0.1:8081/;
            proxy_set_header X-Device-Type "mobile";
        }

        # Bot-specific handling
        location ~ ^/sitemap.*\.xml$ {
            if ($is_bot = 0) {
                return 404;
            }
            root /var/www/seo;
        }

        # Legacy IE support
        location /legacy/ {
            if ($browser != "ie") {
                return 301 /modern/;
            }
            root /var/www/legacy;
        }

        # API with bot rate limiting
        location /api/ {
            limit_req zone=api burst=10;

            if ($is_bot) {
                set $limit_rate 1k;
            }

            proxy_pass http://127.0.0.1:8080;
        }
    }

    limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
}
