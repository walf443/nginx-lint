# Regex for security filtering
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name secure.example.com;
        root /var/www/html;

        # Block SQL injection attempts
        location / {
            if ($args ~* "(union|select|insert|update|delete|drop|truncate|alter|exec|execute)[\s\+]+") {
                return 403;
            }
            if ($args ~* "('|\"|\-\-|;|/\*|\*/|@@|char\(|nchar\(|varchar\(|nvarchar\()") {
                return 403;
            }
            proxy_pass http://127.0.0.1:8080;
        }

        # Block XSS attempts
        location /api/ {
            if ($args ~* "(<|%3c)(script|img|svg|iframe|object|embed|link|style|meta)") {
                return 403;
            }
            if ($args ~* "(javascript|vbscript|expression|onload|onerror|onclick|onmouseover):") {
                return 403;
            }
            proxy_pass http://127.0.0.1:8080;
        }

        # Block path traversal
        location /files/ {
            if ($uri ~* "(\.\.|\.\./|/\.\.|\%2e\%2e)") {
                return 403;
            }
            if ($uri ~* "(etc/passwd|etc/shadow|proc/self)") {
                return 403;
            }
            alias /var/www/files/;
        }

        # Block sensitive file access
        location ~ \.(env|git|svn|htaccess|htpasswd|ini|log|sh|sql|bak|config)$ {
            deny all;
        }

        # Block common vulnerability scanners
        location / {
            if ($http_user_agent ~* "(nikto|sqlmap|nmap|masscan|zgrab|nuclei|dirbuster|gobuster)") {
                return 403;
            }
            proxy_pass http://127.0.0.1:8080;
        }

        # Block WordPress attacks (even if not using WordPress)
        location ~ ^/(wp-admin|wp-login|wp-content|wp-includes|xmlrpc\.php) {
            return 404;
        }

        # Block common attack paths
        location ~ ^/(phpmyadmin|pma|myadmin|mysql|admin|administrator|manager|cgi-bin) {
            return 404;
        }

        # Rate limit login endpoints
        location ~ ^/(login|signin|auth|api/auth) {
            limit_req zone=login burst=5 nodelay;
            proxy_pass http://127.0.0.1:8080;
        }

        # Block requests with suspicious headers
        if ($http_x_forwarded_host ~* "[<>'\"]") {
            return 400;
        }

        # Validate Content-Type for POST requests
        location /api/upload {
            if ($request_method = POST) {
                set $valid_content "";
            }
            if ($content_type ~* "^(multipart/form-data|application/json|application/x-www-form-urlencoded)") {
                set $valid_content "yes";
            }
            if ($valid_content != "yes") {
                return 415;
            }
            proxy_pass http://127.0.0.1:8080;
        }
    }

    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
}
