# Regex for language and locale detection
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Default locale
    map $http_accept_language $detected_lang {
        default en;
        ~^ja ja;
        ~^zh-CN zh-cn;
        ~^zh-TW zh-tw;
        ~^zh zh;
        ~^ko ko;
        ~^de de;
        ~^fr fr;
        ~^es es;
        ~^pt-BR pt-br;
        ~^pt pt;
        ~^ru ru;
        ~^ar ar;
    }

    server {
        listen 80;
        server_name i18n.example.com;
        root /var/www/html;

        # URL path with 2-letter language code: /en/about
        location ~ ^/([a-z]{2})/(.*)$ {
            set $lang $1;
            set $path $2;
            try_files /$lang/$path /$lang/$path/index.html @fallback;
        }

        # URL path with locale: /en-US/about, /zh-CN/about
        location ~ ^/([a-z]{2})-([A-Z]{2})/(.*)$ {
            set $lang $1;
            set $region $2;
            set $path $3;
            try_files /$lang-$region/$path /$lang/$path @fallback;
        }

        # URL path with 3-letter language code (ISO 639-2): /jpn/about
        location ~ ^/([a-z]{3})/(.*)$ {
            set $lang3 $1;
            set $path $2;
            try_files /$lang3/$path @fallback;
        }

        # Language subdomain simulation via rewrite
        # ja.example.com -> /ja/
        if ($host ~ ^([a-z]{2})\.example\.com$) {
            set $subdomain_lang $1;
            rewrite ^(.*)$ /$subdomain_lang$1 last;
        }

        # Detect language from cookie
        location ~ ^/auto/(.*)$ {
            set $path $1;
            set $user_lang $cookie_lang;

            if ($user_lang = '') {
                set $user_lang $detected_lang;
            }

            try_files /$user_lang/$path /$detected_lang/$path /en/$path @fallback;
        }

        # API with locale in path
        location ~ ^/api/([a-z]{2}(?:-[A-Z]{2})?)/(.*)$ {
            set $api_locale $1;
            set $api_path $2;
            proxy_pass http://127.0.0.1:8080/$api_path;
            proxy_set_header Accept-Language $api_locale;
            proxy_set_header X-Locale $api_locale;
        }

        location @fallback {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header X-Detected-Lang $detected_lang;
        }
    }
}
