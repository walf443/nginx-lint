# URL redirects and rewrites
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Redirect map
    map $uri $redirect_uri {
        /old-page /new-page;
        /blog/old-post /articles/new-post;
        /products/123 /shop/item/123;
    }

    # Maintenance mode flag
    map $remote_addr $maintenance_mode {
        default 1;
        10.0.0.0/8 0;
        192.168.1.100 0;
    }

    server {
        listen 80;
        server_name www.example.com example.com;

        # Force www
        if ($host = example.com) {
            return 301 https://www.example.com$request_uri;
        }

        # Force HTTPS
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name www.example.com;

        ssl_certificate /etc/ssl/certs/example.com.pem;
        ssl_certificate_key /etc/ssl/private/example.com.key;

        # Maintenance mode
        if ($maintenance_mode) {
            return 503;
        }

        # Handle redirects from map
        if ($redirect_uri) {
            return 301 $redirect_uri;
        }

        # Trailing slash normalization
        rewrite ^([^.]*[^/])$ $1/ permanent;

        # Remove index.html
        rewrite ^(.*/)index\.html$ $1 permanent;

        # Legacy URL patterns
        rewrite ^/category/([0-9]+)/(.*)$ /c/$1-$2 permanent;
        rewrite ^/user/profile/([a-z]+)$ /u/$1 redirect;

        location / {
            root /var/www/html;
            index index.html;
            try_files $uri $uri/ =404;
        }

        error_page 503 /maintenance.html;
        location = /maintenance.html {
            root /var/www/errors;
            internal;
        }
    }
}
