# uWSGI configuration for Python applications
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # uWSGI cache
    uwsgi_cache_path /var/cache/nginx/uwsgi levels=1:2 keys_zone=uwsgi_cache:10m max_size=500m inactive=30m;

    upstream django_app {
        server unix:/var/run/uwsgi/django.sock;
    }

    upstream flask_app {
        server 127.0.0.1:8001;
        server 127.0.0.1:8002;
        keepalive 32;
    }

    server {
        listen 80;
        listen [::]:80;
        server_name django.example.com;

        location /static/ {
            alias /var/www/django/static/;
            expires 30d;
        }

        location /media/ {
            alias /var/www/django/media/;
            expires 7d;
        }

        location / {
            uwsgi_pass django_app;
            uwsgi_param QUERY_STRING $query_string;
            uwsgi_param REQUEST_METHOD $request_method;
            uwsgi_param CONTENT_TYPE $content_type;
            uwsgi_param CONTENT_LENGTH $content_length;
            uwsgi_param REQUEST_URI $request_uri;
            uwsgi_param PATH_INFO $document_uri;
            uwsgi_param DOCUMENT_ROOT $document_root;
            uwsgi_param SERVER_PROTOCOL $server_protocol;
            uwsgi_param REMOTE_ADDR $remote_addr;
            uwsgi_param REMOTE_PORT $remote_port;
            uwsgi_param SERVER_NAME $server_name;
            uwsgi_param SERVER_PORT $server_port;
            uwsgi_param HTTPS $https if_not_empty;

            uwsgi_read_timeout 300s;
            uwsgi_send_timeout 300s;
            uwsgi_connect_timeout 30s;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name flask.example.com;

        location / {
            uwsgi_pass flask_app;
            uwsgi_param QUERY_STRING $query_string;
            uwsgi_param REQUEST_METHOD $request_method;
            uwsgi_param CONTENT_TYPE $content_type;
            uwsgi_param CONTENT_LENGTH $content_length;
            uwsgi_param REQUEST_URI $request_uri;
            uwsgi_param PATH_INFO $document_uri;
            uwsgi_param SERVER_PROTOCOL $server_protocol;
            uwsgi_param REMOTE_ADDR $remote_addr;
            uwsgi_param SERVER_NAME $server_name;

            # Caching
            uwsgi_cache uwsgi_cache;
            uwsgi_cache_valid 200 10m;
            uwsgi_cache_bypass $arg_nocache;
        }
    }
}
